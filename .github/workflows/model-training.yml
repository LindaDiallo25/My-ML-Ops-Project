name: Model Training Pipeline

on:
  workflow_dispatch:
    inputs:
      epochs:
        description: 'Number of training epochs'
        required: false
        default: '15'
      batch_size:
        description: 'Batch size'
        required: false
        default: '32'

jobs:
  train-model:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        lfs: true
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Download and prepare data
      run: |
        if [ ! -d "cleaned_images_for_model" ] || [ -z "$(ls -A cleaned_images_for_model)" ]; then
          echo "Downloading and cleaning images..."
          python run_import_clean.py
        else
          echo "✅ Training data already exists"
          ls cleaned_images_for_model/ | wc -l
        fi
    
    - name: Train model with MLflow
      run: |
        python train_with_mlflow.py
      env:
        EPOCHS: ${{ github.event.inputs.epochs || '15' }}
        BATCH_SIZE: ${{ github.event.inputs.batch_size || '32' }}
    
    - name: Upload trained model
      uses: actions/upload-artifact@v3
      with:
        name: trained-model-${{ github.sha }}
        path: |
          dandelion_grass_cnn.keras
          training_history.png
        retention-days: 30
    
    - name: Upload MLflow artifacts
      uses: actions/upload-artifact@v3
      with:
        name: mlflow-artifacts-${{ github.sha }}
        path: mlruns/
        retention-days: 30
    
    - name: Model performance summary
      run: |
        echo "## Model Training Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Epochs: ${{ github.event.inputs.epochs || '15' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Batch Size: ${{ github.event.inputs.batch_size || '32' }}" >> $GITHUB_STEP_SUMMARY
        echo "- Model Size: $(ls -lh dandelion_grass_cnn.keras | awk '{print $5}')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "✅ Training completed successfully" >> $GITHUB_STEP_SUMMARY
